


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > ReviewServer</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.example.backend.review</a>
</div>

<h1>Coverage Summary for Class: ReviewServer (com.example.backend.review)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ReviewServer</td>
<td class="coverageStat">
  <span class="percent">
    33.3%
  </span>
  <span class="absValue">
    (3/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    12.9%
  </span>
  <span class="absValue">
    (8/62)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ReviewServer$SessionState</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    23.1%
  </span>
  <span class="absValue">
    (3/13)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    12.1%
  </span>
  <span class="absValue">
    (8/66)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.example.backend.review;
&nbsp;
&nbsp;import com.example.backend.user.User;
&nbsp;import com.example.backend.user.UserRepository;
&nbsp;import com.fasterxml.jackson.core.JsonProcessingException;
&nbsp;import com.fasterxml.jackson.databind.ObjectMapper;
&nbsp;import lombok.AllArgsConstructor;
&nbsp;import lombok.Getter;
&nbsp;import lombok.Setter;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.stereotype.Controller;
&nbsp;
&nbsp;import javax.websocket.*;
&nbsp;import javax.websocket.server.PathParam;
&nbsp;import javax.websocket.server.ServerEndpoint;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.Map;
&nbsp;
&nbsp;@Controller
&nbsp;@ServerEndpoint(value = &quot;/review/{netId}/{id}&quot;)
<b class="fc">&nbsp;public class ReviewServer {</b>
<b class="fc">&nbsp;    private static Map&lt;Session, SessionState&gt; sessionStateMap = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;    private static Map&lt;SessionState, Session&gt; stateSessionMap = new HashMap&lt;&gt;();</b>
&nbsp;
<b class="fc">&nbsp;    private final Logger logger = LoggerFactory.getLogger(ReviewServer.class);</b>
&nbsp;
<b class="fc">&nbsp;    private ObjectMapper objectMapper = new ObjectMapper();</b>
&nbsp;
&nbsp;    private static ReviewRepository rr;
&nbsp;    private static MenuItemRepository mir;
&nbsp;    private static UserRepository ur;
&nbsp;
&nbsp;    @Autowired
&nbsp;    public void setMessageRepository(ReviewRepository rr, MenuItemRepository mir, UserRepository urr) {
<b class="fc">&nbsp;        ReviewServer.rr = rr;</b>
<b class="fc">&nbsp;        ReviewServer.mir = mir;</b>
<b class="fc">&nbsp;        ReviewServer.ur = urr;</b>
&nbsp;    }
&nbsp;
&nbsp;    @OnOpen
&nbsp;    public void onOpen(Session session, @PathParam(&quot;netId&quot;) String netId, @PathParam(&quot;id&quot;) String id) {
<b class="nc">&nbsp;        logger.info(&quot;(&quot; + session.getId() + &quot;) &quot; + netId + &quot; connected to review server&quot;);</b>
&nbsp;
<b class="nc">&nbsp;        mir.findById(Long.parseLong(id));</b>
<b class="nc">&nbsp;        User user = ur.findByNetId(netId);</b>
<b class="nc">&nbsp;        MenuItem menuItem = mir.findById(Long.parseLong(id));</b>
&nbsp;
<b class="nc">&nbsp;        if (user == null || menuItem == null) {</b>
<b class="nc">&nbsp;            logger.info(&quot;(&quot; + session.getId() + &quot;) &quot; + netId + &quot; failed to connect to review server&quot;);</b>
<b class="nc">&nbsp;            throw new IllegalArgumentException(&quot;User or menu item not found&quot;);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        SessionState state = new SessionState(user, menuItem);</b>
<b class="nc">&nbsp;        sessionStateMap.put(session, state);</b>
<b class="nc">&nbsp;        stateSessionMap.put(state, session);</b>
&nbsp;
<b class="nc">&nbsp;        ArrayList&lt;Review&gt; reviews = rr.findAllByMenuItem(menuItem);</b>
<b class="nc">&nbsp;        reviews.forEach((review) -&gt; {</b>
&nbsp;            try {
<b class="nc">&nbsp;                session.getBasicRemote().sendText(objectMapper.writeValueAsString(new ReviewResponse(review)));</b>
<b class="nc">&nbsp;            } catch (JsonProcessingException e) {</b>
<b class="nc">&nbsp;                e.printStackTrace();</b>
<b class="nc">&nbsp;            } catch (Exception e) {</b>
<b class="nc">&nbsp;                e.printStackTrace();</b>
<b class="nc">&nbsp;            }</b>
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    @OnMessage
&nbsp;    public void onMessage(Session session, String message) throws JsonProcessingException {
<b class="nc">&nbsp;        SessionState state = sessionStateMap.get(session);</b>
<b class="nc">&nbsp;        logger.info(&quot;(&quot; + session.getId() + &quot;) &quot; + state.getUser().getNetId() + &quot; sent message: &quot; + message);</b>
&nbsp;
<b class="nc">&nbsp;        MenuItem menuItem = state.getMenuItem();</b>
<b class="nc">&nbsp;        Review review = rr.findByUserAndMenuItem(state.getUser(), state.getMenuItem());</b>
<b class="nc">&nbsp;        Review payload = objectMapper.readValue(message, Review.class);</b>
<b class="nc">&nbsp;        if (review == null) { // Review does not exist</b>
<b class="nc">&nbsp;            review = payload;</b>
<b class="nc">&nbsp;            review.setUser(state.getUser());</b>
<b class="nc">&nbsp;            review.setMenuItem(state.getMenuItem());</b>
<b class="nc">&nbsp;            menuItem.incrementNumRatings(); // Only increase num of ratings if review is new</b>
&nbsp;        } else { // Review exists
<b class="nc">&nbsp;            review.setComment(payload.getComment());</b>
<b class="nc">&nbsp;            review.setRating(payload.getRating());</b>
&nbsp;        }
<b class="nc">&nbsp;        rr.save(review);</b>
&nbsp;
<b class="nc">&nbsp;        ArrayList&lt;Review&gt; allReviews = rr.findAllByMenuItem(menuItem);</b>
<b class="nc">&nbsp;        int totalCount = 0;</b>
<b class="nc">&nbsp;        for (Review r : allReviews) {</b>
<b class="nc">&nbsp;            totalCount += r.getRating();</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        float rating = (float) totalCount / menuItem.getNumRatings();</b>
<b class="nc">&nbsp;        float roundedRating = Math.round(rating * 2) / (float) 2.0;</b>
<b class="nc">&nbsp;        menuItem.setCachedRating(roundedRating);</b>
<b class="nc">&nbsp;        mir.save(menuItem);</b>
&nbsp;
&nbsp;        // Broadcast review to all clients
<b class="nc">&nbsp;        final ReviewResponse reviewResponse = new ReviewResponse(review);</b>
<b class="nc">&nbsp;        sessionStateMap.forEach((s, ss) -&gt; {</b>
<b class="nc">&nbsp;            if (ss.getMenuItem().getId() == menuItem.getId()) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    s.getBasicRemote().sendText(objectMapper.writeValueAsString(reviewResponse));</b>
<b class="nc">&nbsp;                } catch (JsonProcessingException e) {</b>
<b class="nc">&nbsp;                    e.printStackTrace();</b>
<b class="nc">&nbsp;                } catch (Exception e) {</b>
<b class="nc">&nbsp;                    e.printStackTrace();</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            }
&nbsp;        });
&nbsp;    }
&nbsp;
&nbsp;    @OnClose
&nbsp;    public void onClose(Session session) {
<b class="nc">&nbsp;        SessionState state = sessionStateMap.get(session);</b>
&nbsp;
<b class="nc">&nbsp;        stateSessionMap.remove(state);</b>
<b class="nc">&nbsp;        sessionStateMap.remove(session);</b>
&nbsp;
<b class="nc">&nbsp;        logger.info(&quot;(&quot; + session.getId() + &quot;) &quot; + state.user.getNetId() + &quot; disconnected from review server&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    @OnError
&nbsp;    public void onError(Session session, Throwable throwable) {
<b class="nc">&nbsp;        logger.error(&quot;(&quot; + session.getId() + &quot;) &quot; + throwable.getMessage());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Getter
<b class="nc">&nbsp;    @Setter</b>
<b class="nc">&nbsp;    @AllArgsConstructor</b>
&nbsp;    private class SessionState {
<b class="nc">&nbsp;        public User user;</b>
<b class="nc">&nbsp;        public MenuItem menuItem;</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2022-12-07 17:51</div>
</div>
</body>
</html>
